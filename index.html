<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mood & Spin</title>

  <!-- iOS full-screen hints -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#1b1d21">

  <style>
    :root{
      /* Sleek dark + signal colors */
      --bg:#1b1d21;          /* page */
      --surface:#23262b;     /* cards */
      --surface-2:#1f2227;   /* header/footer */
      --fg:#ececf1;          /* text */
      --muted:#a9adba;       /* secondary */

      /* Mood (dark) */
      --mood-red:#b91c1c;    /* dark red */
      --mood-yellow:#b45309; /* dark amber */
      --mood-green:#166534;  /* dark green */

      /* Energy (light) */
      --energy-red:#FCA5A5;  /* light red */
      --energy-yellow:#FDE68A;/* light yellow */
      --energy-green:#86EFAC;/* light green */

      --accent:#8b5cf6;      /* subtle lavender accent */
      --danger:#ef4444;
      --pad:16px;
      --radius:8px;          /* less rounded */
      --radius-sm:6px;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{background:var(--bg);color:var(--fg)}

    /* Safe-area aware wrapper */
    .wrap{min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
    header{position:sticky;top:0;background:var(--surface-2);
      padding:calc(env(safe-area-inset-top) + 8px) var(--pad) 8px var(--pad);
      display:flex;align-items:center;gap:12px;z-index:10;border-bottom:1px solid rgba(255,255,255,.06)}
    h1{font-size:18px;margin:0;font-weight:600}
    .spacer{height:8px}

    .card{margin:12px;padding:var(--pad);border-radius:var(--radius);background:var(--surface);
      border:1px solid rgba(255,255,255,.06)}

    /* Buttons */
    button{appearance:none;border:1px solid rgba(255,255,255,.10);border-radius:8px;padding:10px 12px;cursor:pointer;color:var(--fg);background:#2b2f35}
    button:hover{filter:brightness(1.06)}
    .primary{background:var(--accent);border-color:transparent;color:#140f24;font-weight:700}
    .ghost{background:transparent}
    .danger{background:var(--danger);border-color:transparent;color:#fff}

    .row{display:flex;gap:8px;align-items:center}
    .between{justify-content:space-between}

    /* Chips (squarer) */
    .chip-row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid rgba(255,255,255,.12);padding:8px 10px;border-radius:8px;cursor:pointer;background:#262a31}
    .chip.active{outline:2px solid var(--accent);outline-offset:0}

    /* 7-day history (sleek squares with inner energy bar) */
    .history{display:grid;grid-template-columns:repeat(7,1fr);gap:6px;margin-top:10px}
    .dot{height:14px;border-radius:4px;background:#343842;position:relative;overflow:hidden;border:1px solid rgba(255,255,255,.08)}
    .dot .inner{position:absolute;left:50%;transform:translateX(-50%);bottom:1px;width:4px;border-radius:3px}

    textarea{width:100%;min-height:70px;border-radius:8px;border:1px solid rgba(255,255,255,.12);background:#1e2025;color:var(--fg);padding:10px;resize:vertical}

    /* Spinner */
    .list{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:#2b2f35;border:1px solid rgba(255,255,255,.10)}
    .pill.done{opacity:.75;text-decoration:line-through}
    .pill .x{appearance:none;background:transparent;border:0;color:#c2c6d4;cursor:pointer;font-size:14px;line-height:1}
    .pill .x:hover{color:#fff}

    .result{margin-top:10px;padding:12px;border-radius:8px;background:#1e2025;border:1px dashed rgba(255,255,255,.15);display:flex;align-items:center;gap:8px}
    .result.hidden{display:none}

    /* Spin animation */
    #wheel{width:24px;height:24px;border-radius:50%;border:3px solid #a78bfa;border-top-color:#6d28d9;display:none}
    .spinning #wheel{display:inline-block;animation:spin 0.9s linear infinite}
    .spinning #spinBtn{pointer-events:none;opacity:.7}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    footer{background:var(--surface-2);padding:8px var(--pad) calc(env(safe-area-inset-bottom) + 8px);color:var(--muted);font-size:12px;border-top:1px solid rgba(255,255,255,.06)}

    /* Summary section */
    #summaryWrap{display:none;margin-top:10px}
    #summaryWrap.open{display:block}
    #summaryCanvas{width:100%;height:100px;display:block}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Mood & Spin</h1>
    <div class="row" style="margin-left:auto">
      <button id="shareBtn" class="ghost">Share</button>
      <button id="wipeBtn" class="danger">Wipe</button>
    </div>
  </header>

  <main>
    <div class="spacer"></div>

    <!-- Mood/Energy Card -->
    <section class="card" aria-labelledby="moodhdr">
      <div class="row between">
        <h2 id="moodhdr" style="margin:0;font-size:16px;font-weight:600">Today ¬∑ <span id="today"></span></h2>
        <div class="row">
          <button id="summaryBtn" class="ghost" title="Show 30‚Äëday summary">30‚Äëday summary</button>
          <button id="saveBtn" class="primary">Save</button>
        </div>
      </div>

      <div style="height:8px"></div>
      <div class="chip-row" id="moodRow" aria-label="Mood"></div>

      <div style="height:8px"></div>
      <div class="chip-row" id="energyRow" aria-label="Energy"></div>

      <div style="height:8px"></div>
      <label for="note" class="sr-only">Note</label>
      <textarea id="note" placeholder="Add a quick note (optional)"></textarea>

      <div class="history" id="history" aria-label="Past 7 days"></div>

      <div id="summaryWrap">
        <canvas id="summaryCanvas"></canvas>
        <div class="row" style="justify-content:space-between;margin-top:6px;color:var(--muted);font-size:12px">
          <span>Last 30 days ¬∑ mood (dark) + energy (light)</span>
          <span id="summaryStats"></span>
        </div>
      </div>
    </section>

    <!-- Spinner Card -->
    <section class="card" aria-labelledby="spinhdr">
      <div class="row between">
        <h2 id="spinhdr" style="margin:0;font-size:16px;font-weight:600">Random Task Spinner</h2>
        <div class="row">
          <input id="newTask" placeholder="Add a task‚Ä¶" style="background:#1e2025;border:1px solid rgba(255,255,255,.12);color:var(--fg);padding:8px 10px;border-radius:6px;min-width:140px"/>
          <button id="addBtn" class="ghost">Add</button>
          <button id="spinBtn" class="primary">Spin üé≤</button>
        </div>
      </div>
      <div class="list" id="taskList"></div>
      <div id="spinResult" class="result hidden">
        <div id="wheel"></div>
        <div id="spinText"></div>
      </div>
    </section>
  </main>

  <footer>
    Offline‚Äëready ‚Ä¢ Add to Home Screen in Safari ‚Ä¢ v1.4
  </footer>
</div>

<script>
// ---- Utilities ----
const fmtDate = (d=new Date())=> d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
const todayKey = ()=> new Date().toISOString().slice(0,10);
const LS_KEY = 'moodspin-v1';
const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY))||{} } catch { return {} } };
const save = s => localStorage.setItem(LS_KEY, JSON.stringify(s));

// State: { entries:{[date]:{mood:number, energy:number, note:string}}, tasks:[string], done:{[date]:{[taskIndex]:true}} }
const EMOJI = ['üò£','üôÅ','üòê','üôÇ','üòÄ']; // 1..5
const ENERGY = ['1','2','3','4','5'];     // 1..5

const moodRow = document.getElementById('moodRow');
const energyRow = document.getElementById('energyRow');
const noteEl = document.getElementById('note');
const historyEl = document.getElementById('history');
const spinResult = document.getElementById('spinResult');
const spinText = document.getElementById('spinText');

function ensureState(){
  const s=load();
  s.entries = s.entries || {};
  s.tasks   = s.tasks   || ['Dishes','Tidy 5 min','Wipe counters','Water plants'];
  s.done    = s.done    || {}; // per-day map
  save(s);
}

function renderHeader(){ document.getElementById('today').textContent = fmtDate(); }

// Color helpers
function moodColor(v){
  if(!v) return '#343842';
  if(v<=2) return getCSS('--mood-red');
  if(v===3) return getCSS('--mood-yellow');
  return getCSS('--mood-green');
}
function energyColor(v){
  if(!v) return '#3a3d46';
  if(v<=2) return getCSS('--energy-red');
  if(v===3) return getCSS('--energy-yellow');
  return getCSS('--energy-green');
}
function getCSS(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }

function renderMoodEnergy(){
  const s=load(); const d=todayKey(); const e=s.entries[d]||{};
  moodRow.innerHTML='';
  EMOJI.forEach((em,i)=>{
    const b=document.createElement('button'); b.className='chip'+(e.mood===i+1?' active':''); b.textContent=em; b.onclick=()=>{ e.mood=i+1; s.entries[d]=e; save(s); renderMoodEnergy(); renderHistory(); drawSummary(); };
    moodRow.appendChild(b);
  });
  energyRow.innerHTML='';
  ENERGY.forEach((lbl,i)=>{
    const b=document.createElement('button'); b.className='chip'+(e.energy===i+1?' active':''); b.textContent='‚ö° '+lbl; b.onclick=()=>{ e.energy=i+1; s.entries[d]=e; save(s); renderMoodEnergy(); renderHistory(); drawSummary(); };
    energyRow.appendChild(b);
  });
  noteEl.value = e.note||'';
}

function renderHistory(){
  const s=load(); historyEl.innerHTML='';
  for(let i=6;i>=0;i--){
    const dt=new Date(); dt.setDate(dt.getDate()-i); const key=dt.toISOString().slice(0,10);
    const e=s.entries[key]||{};
    const dot=document.createElement('div'); dot.className='dot';
    // Mood as background color
    dot.style.background = moodColor(e.mood);
    // Energy as thin center bar with proportional height
    const inner=document.createElement('span'); inner.className='inner';
    inner.style.background = energyColor(e.energy);
    const h = 12 * ((e.energy||0)/5); // 0..12px
    inner.style.height = Math.max(2, Math.round(h)) + 'px';
    dot.appendChild(inner);

    dot.title = `${dt.toDateString()} ‚Ä¢ Mood ${e.mood||'-'} ‚Ä¢ Energy ${e.energy||'-'}`;
    historyEl.appendChild(dot);
  }
}

// Save button commits note too
function saveToday(){ const s=load(); const d=todayKey(); const e=s.entries[d]||{}; e.note = noteEl.value.trim(); s.entries[d]=e; save(s); spinResult.classList.remove('hidden'); spinText.textContent='Saved ‚úì'; setTimeout(()=>{ spinResult.classList.add('hidden'); }, 1200); }

// Spinner with animation and persistent daily strikes
let spinTimer;
function renderTasks(){
  const s=load();
  const d=todayKey();
  s.done[d] = s.done[d] || {};
  const list=document.getElementById('taskList');
  list.innerHTML='';
  s.tasks.forEach((t,idx)=>{
    const pill=document.createElement('span'); pill.className='pill';
    if(s.done[d][idx]) pill.classList.add('done');
    pill.innerHTML = `${t} <button aria-label="Remove task" data-idx="${idx}" class="x">√ó</button>`;
    pill.addEventListener('click', (ev)=>{
      if(ev.target.classList.contains('x')) return; // handled below
      s.done[d][idx] = !s.done[d][idx];
      save(s); renderTasks();
    });
    pill.querySelector('.x').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(confirm('Remove this task from the list?')){
        s.tasks.splice(idx,1);
        Object.keys(s.done).forEach(day=>{ if(s.done[day]) delete s.done[day][idx]; });
        save(s); renderTasks();
      }
    });
    list.appendChild(pill);
  });
}
function addTask(){ const inp=document.getElementById('newTask'); const v=inp.value.trim(); if(!v) return; const s=load(); s.tasks.push(v); save(s); inp.value=''; renderTasks(); }
function spinTask(){ const s=load(); if(!s.tasks.length){ alert('Add a task first'); return; }
  // Start animation
  document.body.classList.add('spinning');
  spinResult.classList.remove('hidden');
  let i=0; spinText.textContent='Spinning‚Ä¶';
  spinTimer = setInterval(()=>{ const pick = s.tasks[i++ % s.tasks.length]; spinText.textContent = 'Spinning‚Ä¶ ' + pick; }, 120);
  setTimeout(()=>{
    clearInterval(spinTimer);
    const final = s.tasks[Math.floor(Math.random()*s.tasks.length)];
    spinText.innerHTML = `<strong>Do this now:</strong> ${final}`;
    document.body.classList.remove('spinning');
  }, 1200);
}

// Share + Wipe
function shareTip(){ if(navigator.share){ navigator.share({title:'Mood & Spin', text:'Add to Home Screen for app‚Äëlike mode', url:location.href}); } else alert('In Safari, tap Share ‚Üí Add to Home Screen'); }
function wipe(){ if(confirm('Wipe all data?')){ localStorage.removeItem(LS_KEY); location.reload(); } }

// 30‚Äëday summary (mood = dark bars, energy = light overlay)
const summaryBtn = document.getElementById('summaryBtn');
const summaryWrap = document.getElementById('summaryWrap');
const summaryCanvas = document.getElementById('summaryCanvas');
const summaryStats = document.getElementById('summaryStats');

function toggleSummary(){ summaryWrap.classList.toggle('open'); if(summaryWrap.classList.contains('open')){ drawSummary(); summaryBtn.textContent='Hide summary'; } else { summaryBtn.textContent='30‚Äëday summary'; } }
summaryBtn.addEventListener('click', toggleSummary);

function drawSummary(){
  const s=load();
  const ctx = summaryCanvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const cssW = summaryCanvas.clientWidth || 300; const cssH = summaryCanvas.clientHeight || 100;
  summaryCanvas.width = Math.floor(cssW*dpr); summaryCanvas.height = Math.floor(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  const days = [];
  for(let i=29;i>=0;i--){ const dt=new Date(); dt.setDate(dt.getDate()-i); const key=dt.toISOString().slice(0,10); days.push({key, dt, entry: s.entries[key]}); }

  // Stats
  let sum=0, count=0;
  days.forEach(d=>{ if(d.entry && d.entry.mood){ sum+=d.entry.mood; count++; }});
  const avg = count? (sum/count).toFixed(2) : '-';
  summaryStats.textContent = `avg ${avg} ‚Ä¢ filled ${count}/30`;

  // Draw bars
  const pad = 8; const w = cssW - pad*2; const h = cssH - pad*2; const gap = 2; const barW = (w/30) - gap;
  days.forEach((d,idx)=>{
    const x = pad + idx*(barW+gap);
    const mood = d.entry && d.entry.mood ? d.entry.mood : 0;
    const energy = d.entry && d.entry.energy ? d.entry.energy : 0;

    // background track
    const track = '#2b2f35';
    const mH = Math.max(2, h * (mood/5));
    const eH = Math.max(2, h * (energy/5));

    // track
    ctx.fillStyle = track; ctx.fillRect(x, pad, barW, h);

    // mood bar (dark)
    ctx.fillStyle = moodColor(mood);
    ctx.fillRect(x, pad + (h - mH), barW, mH);

    // energy overlay (light + narrower with alpha)
    const eW = Math.max(2, barW * 0.5);
    const ex = x + (barW - eW)/2;
    ctx.fillStyle = hexWithAlpha(energyColor(energy), 0.85);
    ctx.fillRect(ex, pad + (h - eH), eW, eH);

    // outline
    ctx.strokeStyle = 'rgba(0,0,0,0.25)';
    ctx.strokeRect(x+0.5, pad+0.5, barW-1, h-1);
  });
}
function hexWithAlpha(hex, alpha){
  // hex like #RRGGBB, return rgba()
  if(!hex || hex[0] !== '#') return hex;
  const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// Daily roll: reset strike-throughs for a new day
(function dailyRoll(){
  let last = todayKey();
  setInterval(()=>{
    const now = todayKey();
    if(now!==last){
      const s=load(); s.done[now] = s.done[now] || {}; save(s); last = now; renderTasks(); renderHeader(); renderHistory(); drawSummary();
    }
  }, 60*1000);
})();

// Init
ensureState();
renderHeader();
renderMoodEnergy();
renderHistory();
renderTasks();

document.getElementById('saveBtn').onclick = saveToday;
document.getElementById('addBtn').onclick = addTask;
document.getElementById('spinBtn').onclick = spinTask;
document.getElementById('shareBtn').onclick = shareTip;
document.getElementById('wipeBtn').onclick = wipe;

// Register SW for offline
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>
</body>
</html>
