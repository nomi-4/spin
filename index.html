<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Mood & Spin</title>

  <!-- iOS full-screen hints -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="apple-touch-icon" href="icons/icon-180.png">

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#0b0c10">

  <!-- Font: Space Grotesk -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      /* Background + neon accents */
      --bg:#0b0c10;            /* deep space */
      --grid:#1a1d25;          /* subtle grid lines */
      --neon-cyan:#00e5ff;
      --neon-magenta:#ff2bd6;
      --neon-violet:#8b5cf6;

      /* Glass surfaces */
      --glass:rgba(255,255,255,.06);
      --glass-stroke:rgba(255,255,255,.18);
      --fg:#e9eaf2;
      --muted:#b8bbcc;

      /* Mood (dark) */
      --mood-red:#b91c1c;    /* dark red */
      --mood-yellow:#b45309; /* dark amber */
      --mood-green:#166534;  /* dark green */

      /* Energy (light) */
      --energy-red:#FCA5A5;  /* light red */
      --energy-yellow:#FDE68A;/* light yellow */
      --energy-green:#86EFAC;/* light green */

      --radius:10px;
      --pad:16px;
    }

    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:"Space Grotesk",Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    body{color:var(--fg); background: radial-gradient(1200px 600px at 50% -10%, rgba(0,229,255,.12), transparent 60%), radial-gradient(900px 500px at 120% 10%, rgba(255,43,214,.10), transparent 60%), var(--bg);}    

    /* Neon grid overlay */
    body::before{content:""; position:fixed; inset:0; pointer-events:none; background:
      repeating-linear-gradient(to right, rgba(255,255,255,.04) 0 1px, transparent 1px 40px),
      repeating-linear-gradient(to bottom, rgba(255,255,255,.04) 0 1px, transparent 1px 40px);
      mask: linear-gradient(to bottom, transparent 0, rgba(0,0,0,.6) 10%, rgba(0,0,0,.9) 60%, rgba(0,0,0,.6) 100%);
    }

    /* Layout */
    .wrap{min-height:100dvh;display:grid;grid-template-rows:1fr auto}

    header{position:sticky;top:0;z-index:20;
      background:linear-gradient(180deg, rgba(0,0,0,.55), rgba(0,0,0,.25));
      -webkit-backdrop-filter: blur(10px) saturate(140%);
      backdrop-filter: blur(10px) saturate(140%);
      padding:calc(env(safe-area-inset-top) + 8px) var(--pad) 8px var(--pad);
      border-bottom:1px solid var(--glass-stroke);
    }

    /* Bottom nav */
    .bottombar{position:sticky;bottom:0;z-index:20;display:flex;align-items:center;justify-content:space-between;gap:10px;
      padding:8px var(--pad) calc(env(safe-area-inset-bottom) + 10px) var(--pad);
      background:linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.6));
      -webkit-backdrop-filter: blur(10px) saturate(140%);backdrop-filter: blur(10px) saturate(140%);
      border-top:1px solid var(--glass-stroke);
    }
    .bottombar .left{display:flex;gap:8px}
    .bottombar .right{display:flex;gap:8px}
    .btab{appearance:none;border:1px solid var(--glass-stroke);background:rgba(255,255,255,.04);color:var(--fg);padding:10px 14px;border-radius:12px;cursor:pointer}
    .btab.active{background:linear-gradient(135deg, rgba(0,229,255,.28), rgba(255,43,214,.28));border-color:transparent;color:#0b0c10;font-weight:800;box-shadow:0 0 18px rgba(0,229,255,.2)}
    .bghost{appearance:none;border:1px solid var(--glass-stroke);background:transparent;color:var(--fg);padding:10px 12px;border-radius:10px;cursor:pointer}
    .bdanger{appearance:none;border:0;background:linear-gradient(135deg, rgba(239,68,68,.9), rgba(239,68,68,.7));color:#fff;padding:10px 12px;border-radius:10px;cursor:pointer}

    /* Screens */
    main{position:relative;min-height:0}
    .screen{position:absolute;inset:0;overflow:auto;padding:14px}
    .screen.hidden{display:none}

    /* Glass panel feel, but full-bleed */
    .panel{position:relative;border-radius:var(--radius);padding:18px;background:var(--glass);border:1px solid var(--glass-stroke);
      -webkit-backdrop-filter: blur(12px) saturate(160%);backdrop-filter: blur(12px) saturate(160%);
      box-shadow:0 20px 50px rgba(0,0,0,.45), 0 0 0 1px rgba(255,255,255,.02) inset;
    }
    .panel h2{margin:0 0 10px;font-size:15px;font-weight:700;letter-spacing:.2px}

    /* Chips */
    .chip-row{display:flex;gap:8px;flex-wrap:wrap}
    .chip{border:1px solid var(--glass-stroke);padding:8px 10px;border-radius:10px;cursor:pointer;background:rgba(255,255,255,.04)}
    .chip.active{outline:2px solid var(--neon-cyan);outline-offset:0; box-shadow:0 0 18px rgba(0,229,255,.25)}

    /* 7-day history */
    .history{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:12px}
    .dot{height:16px;border-radius:6px;background:#242733;position:relative;overflow:hidden;border:1px solid var(--glass-stroke)}
    .dot .inner{position:absolute;left:50%;transform:translateX(-50%);bottom:1px;width:5px;border-radius:4px;box-shadow:0 0 10px rgba(255,255,255,.2)}

    textarea{width:100%;min-height:76px;border-radius:10px;border:1px solid var(--glass-stroke);background:rgba(255,255,255,.05);color:var(--fg);padding:10px;resize:vertical}

    /* Spinner & tasks */
    .list{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;background:rgba(255,255,255,.05);border:1px solid var(--glass-stroke)}
    .pill.done{opacity:.85;text-decoration:line-through}
    .pill .x{appearance:none;background:transparent;border:0;color:#d4d6e2;cursor:pointer;font-size:14px;line-height:1}
    .pill .x:hover{color:#fff}

    .result{margin-top:12px;padding:12px;border-radius:10px;background:rgba(255,255,255,.05);border:1px dashed var(--glass-stroke);display:flex;align-items:center;gap:10px}
    .result.hidden{display:none}

    /* Spin animation */
    #wheel{width:26px;height:26px;border-radius:50%;border:3px solid var(--neon-cyan);border-top-color:var(--neon-magenta);display:none}
    .spinning #wheel{display:inline-block;animation:spin 0.9s linear infinite}
    .spinning #spinBtn{pointer-events:none;opacity:.7}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}}

    /* Summary section */
    #summaryWrap{display:none;margin-top:10px}
    #summaryWrap.open{display:block}
    #summaryCanvas{width:100%;height:120px;display:block}

    /* Reduce motion */
    @media (prefers-reduced-motion: reduce){ .spinning #wheel{animation:none} }
  </style>
</head>
<body>
<div class="wrap">
  

  <main>
    <!-- Mood Screen -->
    <section id="moodTab" class="screen">
      <div class="panel" aria-labelledby="moodhdr">
        <div class="row between">
          <h2 id="moodhdr">Today · <span id="today"></span></h2>
          <div class="row">
            <button id="summaryBtn" class="ghost" title="Show 30‑day summary">30‑day</button>
            <button id="saveBtn" class="primary">Save</button>
          </div>
        </div>

        <div style="height:6px"></div>
        <div class="chip-row" id="moodRow" aria-label="Mood"></div>

        <div style="height:6px"></div>
        <div class="chip-row" id="energyRow" aria-label="Energy"></div>

        <div style="height:8px"></div>
        <label for="note" class="sr-only">Note</label>
        <textarea id="note" placeholder="Add a quick note (optional)"></textarea>

        <div class="history" id="history" aria-label="Past 7 days"></div>

        <div id="summaryWrap">
          <canvas id="summaryCanvas"></canvas>
          <div class="row" style="justify-content:space-between;margin-top:6px;color:var(--muted);font-size:12px">
            <span>Last 30 days · mood (dark) + energy (light)</span>
            <span id="summaryStats"></span>
          </div>
        </div>
      </div>
    </section>

    <!-- Tasks Screen -->
    <section id="tasksTab" class="screen hidden">
      <div class="panel" aria-labelledby="spinhdr">
        <div class="row between">
          <h2 id="spinhdr">Random Task Spinner</h2>
          <div class="row">
            <input id="newTask" placeholder="Add a task…" style="background:rgba(255,255,255,.06);border:1px solid var(--glass-stroke);color:var(--fg);padding:8px 10px;border-radius:10px;min-width:140px"/>
            <button id="addBtn" class="ghost">Add</button>
            <button id="spinBtn" class="primary">Spin 🎲</button>
          </div>
        </div>
        <div class="list" id="taskList"></div>
        <div id="spinResult" class="result hidden">
          <div id="wheel"></div>
          <div id="spinText"></div>
        </div>
      </div>
    </section>
  </main>

  <nav class="bottombar" role="tablist" aria-label="Primary">
    <div class="left">
      <button id="btabMood" class="btab active" role="tab" aria-selected="true" aria-controls="moodTab">Mood</button>
      <button id="btabTasks" class="btab" role="tab" aria-selected="false" aria-controls="tasksTab">Tasks</button>
    </div>
    <div class="right">
      <button id="shareBtn" class="bghost">Share</button>
      <button id="wipeBtn" class="bdanger">Wipe</button>
    </div>
  </nav>
</div>

<script>
// ---- Utilities ----
const fmtDate = (d=new Date())=> d.toLocaleDateString(undefined,{weekday:'short', month:'short', day:'numeric'});
const todayKey = ()=> new Date().toISOString().slice(0,10);
const LS_KEY = 'moodspin-v1';
const load = () => { try { return JSON.parse(localStorage.getItem(LS_KEY))||{} } catch { return {} } };
const save = s => localStorage.setItem(LS_KEY, JSON.stringify(s));

// Tabs
const tabMoodBtn = document.getElementById('btabMood');
const tabTasksBtn = document.getElementById('btabTasks');
const moodScreen = document.getElementById('moodTab');
const tasksScreen = document.getElementById('tasksTab');
function showTab(which){
  const moodActive = which==='mood';
  tabMoodBtn.classList.toggle('active', moodActive);
  tabTasksBtn.classList.toggle('active', !moodActive);
  tabMoodBtn.setAttribute('aria-selected', moodActive);
  tabTasksBtn.setAttribute('aria-selected', !moodActive);
  moodScreen.classList.toggle('hidden', !moodActive);
  tasksScreen.classList.toggle('hidden', moodActive);
}

// State: { entries:{[date]:{mood:number, energy:number, note:string}}, tasks:[string], done:{[date]:{[taskIndex]:true}} }
const EMOJI = ['😣','🙁','😐','🙂','😀']; // 1..5
const ENERGY = ['1','2','3','4','5'];     // 1..5

const moodRow = document.getElementById('moodRow');
const energyRow = document.getElementById('energyRow');
const noteEl = document.getElementById('note');
const historyEl = document.getElementById('history');
const spinResult = document.getElementById('spinResult');
const spinText = document.getElementById('spinText');

function ensureState(){
  const s=load();
  s.entries = s.entries || {};
  s.tasks   = s.tasks   || ['Dishes','Tidy 5 min','Wipe counters','Water plants'];
  s.done    = s.done    || {}; // per-day map
  save(s);
}

function renderHeader(){ document.getElementById('today').textContent = fmtDate(); }

// Color helpers
function cssVar(name){ return getComputedStyle(document.documentElement).getPropertyValue(name).trim(); }
function moodColor(v){
  if(!v) return '#222733';
  if(v<=2) return cssVar('--mood-red');
  if(v===3) return cssVar('--mood-yellow');
  return cssVar('--mood-green');
}
function energyColor(v){
  if(!v) return '#3a3d46';
  if(v<=2) return cssVar('--energy-red');
  if(v===3) return cssVar('--energy-yellow');
  return cssVar('--energy-green');
}

function renderMoodEnergy(){
  const s=load(); const d=todayKey(); const e=s.entries[d]||{};
  moodRow.innerHTML='';
  EMOJI.forEach((em,i)=>{
    const b=document.createElement('button'); b.className='chip'+(e.mood===i+1?' active':''); b.textContent=em; b.onclick=()=>{ e.mood=i+1; s.entries[d]=e; save(s); renderMoodEnergy(); renderHistory(); drawSummary(); };
    moodRow.appendChild(b);
  });
  energyRow.innerHTML='';
  ENERGY.forEach((lbl,i)=>{
    const b=document.createElement('button'); b.className='chip'+(e.energy===i+1?' active':''); b.textContent='⚡ '+lbl; b.onclick=()=>{ e.energy=i+1; s.entries[d]=e; save(s); renderMoodEnergy(); renderHistory(); drawSummary(); };
    energyRow.appendChild(b);
  });
  noteEl.value = e.note||'';
}

function renderHistory(){
  const s=load(); historyEl.innerHTML='';
  for(let i=6;i>=0;i--){
    const dt=new Date(); dt.setDate(dt.getDate()-i); const key=dt.toISOString().slice(0,10);
    const e=s.entries[key]||{};
    const dot=document.createElement('div'); dot.className='dot';
    // Mood as background color
    dot.style.background = moodColor(e.mood);
    // Energy as thin center bar with proportional height
    const inner=document.createElement('span'); inner.className='inner';
    inner.style.background = energyColor(e.energy);
    const h = 14 * ((e.energy||0)/5); // 0..14px
    inner.style.height = Math.max(2, Math.round(h)) + 'px';
    dot.appendChild(inner);

    dot.title = `${dt.toDateString()} • Mood ${e.mood||'-'} • Energy ${e.energy||'-'}`;
    historyEl.appendChild(dot);
  }
}

// Save button commits note too
function saveToday(){ const s=load(); const d=todayKey(); const e=s.entries[d]||{}; e.note = noteEl.value.trim(); s.entries[d]=e; save(s); spinResult.classList.remove('hidden'); spinText.textContent='Saved ✓'; setTimeout(()=>{ spinResult.classList.add('hidden'); }, 1200); }

// Spinner with animation and persistent daily strikes
let spinTimer;
function renderTasks(){
  const s=load();
  const d=todayKey();
  s.done[d] = s.done[d] || {};
  const list=document.getElementById('taskList');
  list.innerHTML='';
  s.tasks.forEach((t,idx)=>{
    const pill=document.createElement('span'); pill.className='pill';
    if(s.done[d][idx]) pill.classList.add('done');
    pill.innerHTML = `${t} <button aria-label="Remove task" data-idx="${idx}" class="x">×</button>`;
    pill.addEventListener('click', (ev)=>{
      if(ev.target.classList.contains('x')) return; // handled below
      s.done[d][idx] = !s.done[d][idx];
      save(s); renderTasks();
    });
    pill.querySelector('.x').addEventListener('click', (ev)=>{
      ev.stopPropagation();
      if(confirm('Remove this task from the list?')){
        s.tasks.splice(idx,1);
        Object.keys(s.done).forEach(day=>{ if(s.done[day]) delete s.done[day][idx]; });
        save(s); renderTasks();
      }
    });
    list.appendChild(pill);
  });
}
function addTask(){ const inp=document.getElementById('newTask'); const v=inp.value.trim(); if(!v) return; const s=load(); s.tasks.push(v); save(s); inp.value=''; renderTasks(); }
function spinTask(){ const s=load(); if(!s.tasks.length){ alert('Add a task first'); return; }
  // Start animation
  document.body.classList.add('spinning');
  spinResult.classList.remove('hidden');
  let i=0; spinText.textContent='Spinning…';
  spinTimer = setInterval(()=>{ const pick = s.tasks[i++ % s.tasks.length]; spinText.textContent = 'Spinning… ' + pick; }, 120);
  setTimeout(()=>{
    clearInterval(spinTimer);
    const final = s.tasks[Math.floor(Math.random()*s.tasks.length)];
    spinText.innerHTML = `<strong>Do this now:</strong> ${final}`;
    document.body.classList.remove('spinning');
  }, 1200);
}

// Share + Wipe
function shareTip(){ if(navigator.share){ navigator.share({title:'Mood & Spin', text:'Add to Home Screen for app‑like mode', url:location.href}); } else alert('In Safari, tap Share → Add to Home Screen'); }
function wipe(){ if(confirm('Wipe all data?')){ localStorage.removeItem(LS_KEY); location.reload(); } }

// 30‑day summary (mood = dark bars, energy = light overlay)
const summaryBtn = document.getElementById('summaryBtn');
const summaryWrap = document.getElementById('summaryWrap');
const summaryCanvas = document.getElementById('summaryCanvas');
const summaryStats = document.getElementById('summaryStats');

function toggleSummary(){ summaryWrap.classList.toggle('open'); if(summaryWrap.classList.contains('open')){ drawSummary(); summaryBtn.textContent='Hide'; } else { summaryBtn.textContent='30‑day'; } }
summaryBtn.addEventListener('click', toggleSummary);

function drawSummary(){
  const s=load();
  const ctx = summaryCanvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const cssW = summaryCanvas.clientWidth || 320; const cssH = summaryCanvas.clientHeight || 120;
  summaryCanvas.width = Math.floor(cssW*dpr); summaryCanvas.height = Math.floor(cssH*dpr);
  ctx.setTransform(dpr,0,0,dpr,0,0);
  ctx.clearRect(0,0,cssW,cssH);

  const days = [];
  for(let i=29;i>=0;i--){ const dt=new Date(); dt.setDate(dt.getDate()-i); const key=dt.toISOString().slice(0,10); days.push({key, dt, entry: s.entries[key]}); }

  // Stats
  let sum=0, count=0;
  days.forEach(d=>{ if(d.entry && d.entry.mood){ sum+=d.entry.mood; count++; }});
  const avg = count? (sum/count).toFixed(2) : '-';
  summaryStats.textContent = `avg ${avg} • filled ${count}/30`;

  // Draw bars
  const pad = 10; const w = cssW - pad*2; const h = cssH - pad*2; const gap = 2; const barW = (w/30) - gap;
  days.forEach((d,idx)=>{
    const x = pad + idx*(barW+gap);
    const mood = d.entry && d.entry.mood ? d.entry.mood : 0;
    const energy = d.entry && d.entry.energy ? d.entry.energy : 0;

    // track
    ctx.fillStyle = 'rgba(255,255,255,.05)'; ctx.fillRect(x, pad, barW, h);

    // mood bar (dark)
    const mH = Math.max(2, h * (mood/5));
    ctx.fillStyle = moodColor(mood);
    ctx.fillRect(x, pad + (h - mH), barW, mH);

    // energy overlay (light + narrower with alpha)
    const eH = Math.max(2, h * (energy/5));
    const eW = Math.max(2, barW * 0.52);
    const ex = x + (barW - eW)/2;
    ctx.fillStyle = hexA(energyColor(energy), 0.9);
    ctx.fillRect(ex, pad + (h - eH), eW, eH);

    // outline
    ctx.strokeStyle = 'rgba(0,0,0,0.25)';
    ctx.strokeRect(x+0.5, pad+0.5, barW-1, h-1);
  });
}
function hexA(hex, a){
  if(!hex || hex[0] !== '#') return hex; const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16); return `rgba(${r},${g},${b},${a})`;
}

// Daily roll: reset strike-throughs for a new day
(function dailyRoll(){
  let last = todayKey();
  setInterval(()=>{
    const now = todayKey();
    if(now!==last){
      const s=load(); s.done[now] = s.done[now] || {}; save(s); last = now; renderTasks(); renderHeader(); renderHistory(); drawSummary();
    }
  }, 60*1000);
})();

// Init
ensureState();
renderHeader();
renderMoodEnergy();
renderHistory();
renderTasks();
showTab('mood');

document.getElementById('saveBtn').onclick = saveToday;
document.getElementById('addBtn').onclick = addTask;
document.getElementById('spinBtn').onclick = spinTask;
document.getElementById('shareBtn').onclick = shareTip;
document.getElementById('wipeBtn').onclick = wipe;

tabMoodBtn.onclick = ()=> showTab('mood');
tabTasksBtn.onclick = ()=> showTab('tasks');

// Register SW for offline
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    navigator.serviceWorker.register('./service-worker.js').catch(console.error);
  });
}
</script>
</body>
</html>
